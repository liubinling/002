/*
 * BcaTool_LocateClassPanel.java
 *
 * Created on 2007年8月10日, 下午3:28
 */
package com.bca.toolkit.top.tools.util;

import com.bca.agent.qinbi.QinbiConst;
import com.bca.agent.qinbi.api.QinbiClientApi;
import com.bca.agent.qinbi.beans.po.BnMember;
import com.bca.agent.qinbi.beans.po.QinbiComment;
import com.bca.agent.qinbi.beans.xo.BnCardWorksTemplateX;
import com.bca.api.pub.Ret;
import com.bca.pub.WfProcessBean;
import com.bca.pub.tools.Numtool;
import com.bca.pub.tools.Timetool;
import com.bca.pub.tools.Wftool;
import com.bca.toolkit.app.BcaToolkit;
import java.util.Map;

/**
 *
 * @author pxz
 */
public class BcaTool_MtmxPanel extends javax.swing.JPanel {

    final static com.bca.tools.log.Log log = com.bca.tools.log.LogFactory.getLog();
    private QinbiClientApi api;

    /**
     * Creates new form BcaTool_LocateClassPanel
     */
    public BcaTool_MtmxPanel() {
        initComponents();

        wfinit();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        wxnickField = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        memidField = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();
        worksIdField = new javax.swing.JTextField();
        qryMemButton = new javax.swing.JButton();
        qryWorksButton = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        outputField = new javax.swing.JTextPane();
        jLabel6 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        commentField = new javax.swing.JTextPane();
        addCommentButton = new javax.swing.JButton();
        commentMemidField = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        commentVisibleCheck = new javax.swing.JCheckBox();

        jLabel1.setText("查找用户");

        jLabel2.setText("昵称:");

        jLabel3.setText("id:");

        jLabel4.setText("查找作品");

        jLabel5.setText("id:");

        qryMemButton.setText("查");
        qryMemButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                qryMemButtonActionPerformed(evt);
            }
        });

        qryWorksButton.setText("查");
        qryWorksButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                qryWorksButtonActionPerformed(evt);
            }
        });

        jScrollPane2.setViewportView(outputField);

        jLabel6.setText("加评论:");

        jScrollPane1.setViewportView(commentField);

        addCommentButton.setText("加");
        addCommentButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addCommentButtonActionPerformed(evt);
            }
        });

        jLabel7.setText("memid:");

        commentVisibleCheck.setText("仅作者见");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane2)
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(jLabel6)
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(jLabel7)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(commentMemidField, javax.swing.GroupLayout.PREFERRED_SIZE, 42, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addComponent(commentVisibleCheck))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 554, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel1)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jLabel2)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(wxnickField, javax.swing.GroupLayout.PREFERRED_SIZE, 145, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jLabel3)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(memidField))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(jLabel4)
                                .addGap(18, 18, 18)
                                .addComponent(jLabel5)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(worksIdField)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(qryMemButton)
                            .addComponent(qryWorksButton)
                            .addComponent(addCommentButton))))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2)
                    .addComponent(wxnickField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel3)
                    .addComponent(memidField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(qryMemButton))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel4)
                    .addComponent(jLabel5)
                    .addComponent(worksIdField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(qryWorksButton))
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jScrollPane1))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(14, 14, 14)
                                .addComponent(jLabel6))
                            .addGroup(layout.createSequentialGroup()
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(addCommentButton)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(jLabel7)
                            .addComponent(commentMemidField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(commentVisibleCheck)
                        .addGap(0, 10, Short.MAX_VALUE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 342, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void qryMemButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_qryMemButtonActionPerformed

    }//GEN-LAST:event_qryMemButtonActionPerformed

    BnCardWorksTemplateX worksX;
    final Ret ret = new Ret();
    private void qryWorksButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_qryWorksButtonActionPerformed
        final int worksId = Numtool.parseInt(worksIdField.getText());
        final Ret r = new Ret();
        worksX = api.getTemplateXo(worksId, r);
        if (worksX == null) {
            Wftool.messageDialog(false, "未查到");
            this.outputField.setText("");
            return;
        }
        outputField.setText(worksX.toString());
    }//GEN-LAST:event_qryWorksButtonActionPerformed

    private void addCommentButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addCommentButtonActionPerformed
        int memid = Numtool.parseInt(this.commentMemidField.getText());
        if (memid == 0) {
            return;
        }
        BnMember cmem = api.getBnMember(memid, ret);
        if (cmem == null || worksX == null) {
            Wftool.messageDialog(false, "cmem == null || worksX == null");
            return;
        }
        boolean b = Wftool.confirmDialogFmt("加评论，小心！", "用户<%s>将为作品<%d>增加评论. 确认吗?", cmem.getWxNickname(), worksX.getPojo().getWorksTemplateSerl());
        if (!b) {
            return;
        }
        int marksId = api.getNextSerial_int(QinbiConst.QinbiSerialType.QinbiComment, ret);
        QinbiComment marks = new QinbiComment(marksId);
        marks.setCommentDate(Timetool.getSysTimestamp());
        marks.setCommentReplyHead("");
        marks.setCommentReplyId(0);
        marks.setCommentReplyNickname("");
        marks.setCommentUserHead(cmem.getHeadImgUrl());
        marks.setCommentUserId(cmem.getMemberId());
        marks.setCommentUserNickname(cmem.getWxNickname());
        marks.setContent(this.commentField.getText());
        marks.setReplyId(0);
        marks.setScrawlId(worksX.getWorksTemplateSerl());
        marks.setUserHeadImg(worksX.getPojo().getUserHeadImg());
        marks.setUserId(worksX.getPojo().getMemberId());
        marks.setUserNickname(worksX.getPojo().getUserNickname());
        marks.setVirtualFlag(false);
        marks.setWorksState(1);
        marks.setVisibleType(commentVisibleCheck.isSelected() ? 1 : 0);
        if (commentVisibleCheck.isSelected()) {
            marks.setContent(marks.getContent() + "\n(本评论仅作者可见)");
        }
        Ret r2 = api.saveMtmxMarks(marks);
        log.info("saveMtmxMarks(%s):%s", marks, r2);

        Wftool.messageDialog(r2.isRetSuccess(), (r2.isRetSuccess() ? "ok:" : "failure:") + r2.getInfoString());
    }//GEN-LAST:event_addCommentButtonActionPerformed
    final String CR = "\r\n";
    Map<Integer, WfProcessBean> processes = null;

    private void wfinit() {
        BcaToolkit app = BcaToolkit.getApp();
//        app.checkWfBaseConnection(true);
//        WfProcessRegApi baseApi = app.getWfBaseClientApi();
//        if (baseApi == null) {
//            Wftool.messageDialog(false, "与bca服务器连接未通。请检查服务器是否就绪。");
//            return;
//        }
//        Ret ret = new Ret();
//        processes = baseApi.getAllProcesses(ret);
//        if (!ret.isRetSuccess()) {
//            return;
//        }
        api = new QinbiClientApi();
        Ret ret2 = api.connectServer();
        if (!ret2.isRetSuccess()) {
            Wftool.messageDialog(false, "连接米涂米秀服务器失败:" + ret2.getInfoString());
        } else {
            Wftool.messageDialog(true, "连接米涂米秀服务器OK");
        }
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    javax.swing.JButton addCommentButton;
    javax.swing.JTextPane commentField;
    javax.swing.JTextField commentMemidField;
    javax.swing.JCheckBox commentVisibleCheck;
    javax.swing.JLabel jLabel1;
    javax.swing.JLabel jLabel2;
    javax.swing.JLabel jLabel3;
    javax.swing.JLabel jLabel4;
    javax.swing.JLabel jLabel5;
    javax.swing.JLabel jLabel6;
    javax.swing.JLabel jLabel7;
    javax.swing.JScrollPane jScrollPane1;
    javax.swing.JScrollPane jScrollPane2;
    javax.swing.JTextField memidField;
    javax.swing.JTextPane outputField;
    javax.swing.JButton qryMemButton;
    javax.swing.JButton qryWorksButton;
    javax.swing.JTextField worksIdField;
    javax.swing.JTextField wxnickField;
    // End of variables declaration//GEN-END:variables
}
